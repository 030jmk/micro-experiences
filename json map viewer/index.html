<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Viewer &amp; Editor</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
:root {
  --bg: #0f0f0f; --surface: #1a1a2e; --surface2: #16213e; --border: #2a2a4a;
  --text: #e0e0e0; --text2: #8888aa; --accent: #5568f2; --danger: #e74c3c;
  --success: #2ecc71; --warn: #f39c12;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

/* Top bar */
#topbar {
  height: 50px; background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0 16px; display: flex; align-items: center; gap: 10px; z-index: 100;
}
#topbar h1 { font-size: 14px; font-weight: 700; color: #fff; white-space: nowrap; }
#topbar .sep { width: 1px; height: 24px; background: var(--border); }
#search {
  padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--bg); color: var(--text); font-size: 12px; width: 220px; outline: none;
}
#search:focus { border-color: var(--accent); }
.spacer { flex: 1; }
.btn {
  padding: 6px 14px; border-radius: 6px; border: none; font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #4458d4; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #27ae60; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #c0392b; }
.btn-outline { background: none; border: 1px solid var(--border); color: var(--text2); }
.btn-outline:hover { border-color: var(--accent); color: var(--text); }
.btn-active { background: var(--accent); color: #fff; border-color: var(--accent); }
#status { font-size: 10px; color: var(--text2); }
#status.saved { color: var(--success); }
#status.unsaved { color: var(--warn); }
#autosave-ind { font-size: 9px; color: var(--text2); }
#counter { font-size: 10px; color: var(--text2); white-space: nowrap; }

/* Main layout */
#main { display: flex; height: calc(100vh - 50px); }

/* Map panel */
#map-panel {
  width: 45%; min-width: 0; position: relative; display: flex; flex-direction: column;
  border-right: 1px solid var(--border); transition: width 0.3s;
}
#map-panel.hidden { width: 0; min-width: 0; overflow: hidden; border-right: none; }
#map { flex: 1; background: #0a0a18; }
#map-info {
  position: absolute; top: 10px; left: 10px; background: var(--surface); padding: 8px 14px;
  border-radius: 8px; border: 1px solid var(--border); font-size: 11px; z-index: 1000;
  max-width: 300px;
}
#map-info .title { font-weight: 700; color: #fff; margin-bottom: 2px; }
#map-info .sub { color: var(--text2); font-size: 10px; }
.no-geo-msg {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  color: var(--text2); font-size: 13px; text-align: center; padding: 40px;
  background: #0a0a18; z-index: 500;
}

/* Filter sidebar in map panel */
#sidebar-filters {
  position: absolute; top: 10px; right: 10px; background: var(--surface); padding: 10px 14px;
  border-radius: 8px; border: 1px solid var(--border); font-size: 11px; z-index: 1000;
  max-height: 80%; overflow-y: auto; min-width: 180px; max-width: 240px;
}
#sidebar-filters::-webkit-scrollbar { width: 3px; }
#sidebar-filters::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
#sidebar-filters h4 {
  font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text2);
  margin: 8px 0 4px; cursor: pointer; user-select: none;
}
#sidebar-filters h4:first-child { margin-top: 0; }
#sidebar-filters h4:hover { color: var(--text); }
.ftag {
  display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px;
  cursor: pointer; border: 1px solid var(--border); background: var(--bg); color: var(--text2);
  margin: 1px; transition: all 0.15s; user-select: none;
}
.ftag:hover { border-color: var(--accent); color: var(--text); }
.ftag.on { background: var(--accent); color: #fff; border-color: var(--accent); }
#filter-reset {
  display: block; margin-top: 6px; background: none; border: 1px solid var(--border); color: var(--text2);
  padding: 3px 10px; border-radius: 8px; cursor: pointer; font-size: 9px; width: 100%;
}
#filter-reset:hover { border-color: var(--danger); color: var(--danger); }

/* Table panel */
#table-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; }
#table-wrap { flex: 1; overflow: auto; }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
thead { position: sticky; top: 0; z-index: 10; }
th {
  background: var(--surface2); color: var(--text2); font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.6px; padding: 7px 8px; text-align: left; border-bottom: 1px solid var(--border);
  white-space: nowrap; user-select: none; cursor: pointer;
}
th:hover { color: var(--text); }
th.sorted-asc::after { content: ' \u25B2'; font-size: 8px; }
th.sorted-desc::after { content: ' \u25BC'; font-size: 8px; }
td {
  padding: 5px 8px; border-bottom: 1px solid #1a1a2a; vertical-align: top;
  max-width: 260px; overflow: hidden; text-overflow: ellipsis;
}
tr:hover td { background: var(--surface2); }
tr.highlight td { background: #1a2744 !important; }
td[contenteditable="true"] { cursor: text; outline: none; white-space: pre-wrap; word-break: break-word; }
td[contenteditable="true"]:focus { background: #1f2a4a; box-shadow: inset 0 0 0 1px var(--accent); border-radius: 2px; }
td a { color: var(--accent); text-decoration: none; font-size: 12px; }
td a:hover { text-decoration: underline; }

/* Row actions */
.row-actions { display: flex; gap: 3px; }
.row-btn {
  width: 22px; height: 22px; border-radius: 5px; border: 1px solid var(--border);
  background: none; color: var(--text2); cursor: pointer; font-size: 11px;
  display: flex; align-items: center; justify-content: center;
}
.row-btn:hover { border-color: var(--accent); color: var(--text); }
.row-btn.del:hover { border-color: var(--danger); color: var(--danger); }

/* Modal */
#edit-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 2000; justify-content: center; align-items: center;
}
#edit-overlay.show { display: flex; }
#edit-modal {
  background: var(--surface); border-radius: 14px; max-width: 600px; width: 95%;
  max-height: 85vh; overflow: hidden; border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
#edit-modal-header {
  padding: 18px 22px 12px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
#edit-modal-header h2 { font-size: 15px; color: #fff; font-weight: 700; }
#edit-modal-body { padding: 14px 22px 22px; overflow-y: auto; max-height: 65vh; }
.fg { margin-bottom: 10px; }
.fg label {
  display: block; font-size: 9px; text-transform: uppercase; letter-spacing: 0.6px;
  color: var(--text2); margin-bottom: 3px;
}
.fg input, .fg textarea {
  width: 100%; padding: 7px 10px; border-radius: 5px; border: 1px solid var(--border);
  background: var(--bg); color: var(--text); font-size: 12px; font-family: inherit; outline: none;
}
.fg input:focus, .fg textarea:focus { border-color: var(--accent); }
.fg textarea { resize: vertical; min-height: 50px; }
.frow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
#edit-modal-footer {
  padding: 12px 22px; border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 8px;
}

/* Detail modal (map click) */
#detail-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 2000; justify-content: center; align-items: center;
}
#detail-overlay.show { display: flex; }
#detail-modal {
  background: var(--surface); border-radius: 14px; max-width: 520px; width: 90%;
  max-height: 80vh; overflow: hidden; border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
#detail-header {
  padding: 20px 24px 14px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: flex-start;
}
#detail-header h2 { font-size: 18px; color: #fff; font-weight: 700; }
#detail-body { padding: 16px 24px 24px; overflow-y: auto; max-height: 65vh; }
.drow { margin-bottom: 12px; }
.drow .dlbl { font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text2); margin-bottom: 2px; }
.drow .dval { font-size: 13px; color: #ccc; line-height: 1.5; word-break: break-word; }
.drow a { color: var(--accent); text-decoration: none; }
.drow a:hover { text-decoration: underline; }

/* Confirm */
#confirm-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  z-index: 3000; justify-content: center; align-items: center;
}
#confirm-overlay.show { display: flex; }
#confirm-box {
  background: var(--surface); border-radius: 10px; padding: 22px; max-width: 340px;
  border: 1px solid var(--border); text-align: center;
}
#confirm-box p { margin-bottom: 14px; font-size: 13px; }
#confirm-box .cbtns { display: flex; gap: 8px; justify-content: center; }

/* Landing / drop zone */
#landing {
  position: fixed; inset: 0; background: var(--bg); z-index: 50;
  display: flex; align-items: center; justify-content: center;
}
#landing.hidden { display: none; }
#drop-zone {
  border: 2px dashed var(--border); border-radius: 16px; padding: 60px 80px;
  text-align: center; transition: all 0.2s; max-width: 500px;
}
#drop-zone.dragover { border-color: var(--accent); background: rgba(85,104,242,0.05); }
#drop-zone h2 { font-size: 20px; color: #fff; margin-bottom: 8px; }
#drop-zone p { color: var(--text2); font-size: 13px; margin-bottom: 20px; }
#drop-zone .or { color: var(--text2); font-size: 11px; margin: 10px 0; }

/* Toast */
#toast {
  position: fixed; bottom: 20px; right: 20px; background: var(--success);
  color: #fff; padding: 8px 18px; border-radius: 6px; font-size: 12px;
  opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 5000;
}
#toast.show { opacity: 1; }

/* Resize handle */
#resize-handle {
  width: 5px; cursor: col-resize; background: transparent; position: relative; z-index: 50;
  flex-shrink: 0;
}
#resize-handle:hover, #resize-handle.active { background: var(--accent); }

/* Leaflet overrides */
.leaflet-popup-content-wrapper { background: var(--surface) !important; color: #ccc !important; border-radius: 10px !important; border: 1px solid var(--border) !important; }
.leaflet-popup-tip { background: var(--surface) !important; }
.leaflet-popup-content { font-size: 12px; margin: 10px 14px; }
.leaflet-popup-content b { color: #fff; }
.popup-link { color: var(--accent); cursor: pointer; font-size: 11px; }
.popup-link:hover { text-decoration: underline; }
.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background: rgba(85,104,242,0.3) !important; }
.marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background: rgba(85,104,242,0.7) !important; color: #fff !important; }
.leaflet-control-layers { background: var(--surface) !important; color: #ccc !important; border: 1px solid var(--border) !important; border-radius: 8px !important; }
.leaflet-control-layers label { color: #ccc !important; }
</style>
</head>
<body>

<!-- Landing / drop zone -->
<div id="landing">
  <div id="drop-zone">
    <h2>JSON Viewer &amp; Editor</h2>
    <p>Open any JSON array file. If it contains geo coordinates, a map will appear automatically.</p>
    <button class="btn btn-primary" onclick="document.getElementById('landing-file').click()">Choose JSON file</button>
    <input type="file" id="landing-file" accept=".json" style="display:none" onchange="handleLandingUpload(event)">
    <div class="or">or drag &amp; drop a .json file here</div>
    <button class="btn btn-outline" id="load-default-btn" style="margin-top:6px;display:none" onclick="loadDefault()">Load xr-companies.json</button>
  </div>
</div>

<!-- Top bar -->
<div id="topbar" style="display:none">
  <h1 id="app-title">JSON Viewer</h1>
  <div class="sep"></div>
  <input type="text" id="search" placeholder="Search...">
  <span id="counter"></span>
  <div class="spacer"></div>
  <span id="status"></span>
  <span id="autosave-ind"></span>
  <button class="btn btn-outline" id="btn-map-toggle" onclick="toggleMap()" title="Toggle map">Map</button>
  <button class="btn btn-outline" onclick="undoLast()" title="Ctrl+Z">Undo</button>
  <button class="btn btn-outline" onclick="redoLast()" title="Ctrl+Shift+Z">Redo</button>
  <button class="btn btn-outline" onclick="document.getElementById('file-input').click()">Open JSON</button>
  <input type="file" id="file-input" accept=".json" style="display:none" onchange="handleFileUpload(event)">
  <button class="btn btn-primary" onclick="openAddModal()">+ Add Row</button>
  <button class="btn btn-success" onclick="saveToFile()">Save</button>
</div>

<!-- Main layout -->
<div id="main" style="display:none">
  <div id="map-panel" class="hidden">
    <div id="map"></div>
    <div id="map-info" style="display:none"><div class="title" id="map-title"></div><div class="sub" id="map-sub"></div></div>
    <div id="sidebar-filters" style="display:none"></div>
  </div>
  <div id="resize-handle" style="display:none"></div>
  <div id="table-panel">
    <div id="table-wrap">
      <table>
        <thead><tr id="header-row"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div id="edit-overlay" onclick="if(event.target===this)closeEditModal()">
  <div id="edit-modal">
    <div id="edit-modal-header">
      <h2 id="edit-title">Add Row</h2>
      <button class="row-btn" onclick="closeEditModal()" style="width:26px;height:26px;font-size:15px">&times;</button>
    </div>
    <div id="edit-modal-body"></div>
    <div id="edit-modal-footer">
      <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" id="edit-save-btn" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- Detail modal (from map) -->
<div id="detail-overlay" onclick="if(event.target===this)closeDetailModal()">
  <div id="detail-modal">
    <div id="detail-header">
      <h2 id="detail-title"></h2>
      <button class="row-btn" onclick="closeDetailModal()" style="width:28px;height:28px;font-size:16px">&times;</button>
    </div>
    <div id="detail-body"></div>
  </div>
</div>

<!-- Confirm dialog -->
<div id="confirm-overlay" onclick="if(event.target===this)closeConfirm()">
  <div id="confirm-box">
    <p id="confirm-msg"></p>
    <div class="cbtns">
      <button class="btn btn-outline" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmAction()">Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
/* ── State ── */
const CACHE_KEY = 'jv-data';
const HIST_KEY = 'jv-hist';
const REDO_KEY = 'jv-redo';
const META_KEY = 'jv-meta';
const SCHEMA_KEY = 'jv-schema';

let data = [];
let filtered = [];
let hist = [];
let redoStack = [];
let columns = [];
let latKey = null, lonKey = null;
let labelKey = null, subtitleKey = null, colorKey = null;
let sortCol = null, sortDir = 'asc';
let editIdx = -1;
let pendingConfirm = null;
let autoSaveTimer = null;
let dirty = false;
let mapVisible = false;
let map = null, markerCluster = null, markers = {};
let activeFilters = {};
let filterableKeys = [];
let fileName = 'data.json';

/* ── Utilities ── */
function toast(msg, ms = 2000) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}
function esc(s) { return (s == null ? '' : String(s)).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function isUrl(v) { return typeof v === 'string' && /^https?:\/\//i.test(v); }
function timeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 5) return 'just now';
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  return Math.floor(s/3600) + 'h ago';
}

/* ── Schema detection ── */
const GEO_LAT = ['lat','latitude','y','_lat'];
const GEO_LON = ['lon','lng','longitude','x','_lon','_lng'];

function detectSchema(arr) {
  if (!arr.length) return;
  const allKeys = new Set();
  const sample = arr.slice(0, Math.min(arr.length, 50));
  sample.forEach(obj => Object.keys(obj).forEach(k => allKeys.add(k)));

  const keys = [...allKeys];

  latKey = null; lonKey = null;
  for (const k of keys) {
    const kl = k.toLowerCase();
    if (!latKey && GEO_LAT.includes(kl)) latKey = k;
    if (!lonKey && GEO_LON.includes(kl)) lonKey = k;
  }

  const hidden = new Set();
  if (latKey) hidden.add(latKey);
  if (lonKey) hidden.add(lonKey);

  columns = keys.filter(k => !hidden.has(k)).map(k => ({
    key: k,
    label: k.replace(/([A-Z])/g, ' $1').replace(/[_-]/g, ' ').trim(),
    w: guessWidth(k, sample),
    long: isLongText(k, sample)
  }));

  labelKey = findBestKey(keys, ['name','title','label','company','unternehmen','id','key']) || columns[0]?.key;
  subtitleKey = findBestKey(keys, ['address','location','standort','city','stadt','description','desc']);
  colorKey = findBestKey(keys, ['type','category','typ','group','class','status','kind']);

  filterableKeys = [];
  for (const k of keys) {
    if (hidden.has(k)) continue;
    const uniq = new Set(sample.map(r => String(r[k] || '')).filter(Boolean));
    if (uniq.size >= 2 && uniq.size <= 30) filterableKeys.push(k);
  }
}

function findBestKey(keys, candidates) {
  for (const c of candidates) {
    const found = keys.find(k => k.toLowerCase() === c);
    if (found) return found;
  }
  return null;
}

function guessWidth(key, sample) {
  const avg = sample.reduce((s, r) => s + String(r[key] || '').length, 0) / sample.length;
  if (avg > 80) return 240;
  if (avg > 40) return 200;
  if (avg > 20) return 160;
  if (avg > 8) return 120;
  return 80;
}

function isLongText(key, sample) {
  const avg = sample.reduce((s, r) => s + String(r[key] || '').length, 0) / sample.length;
  return avg > 40;
}

function hasGeo() { return latKey && lonKey; }

function geoItems() { return data.filter(r => r[latKey] != null && r[lonKey] != null && !isNaN(r[latKey]) && !isNaN(r[lonKey])); }

/* ── Color palette for categorical data ── */
const PALETTE = ['#e74c3c','#3498db','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22','#95a5a6','#c0392b','#2980b9','#27ae60','#8e44ad','#d35400','#16a085','#7f8c8d','#f1c40f'];
let colorMap = {};

function buildColorMap() {
  colorMap = {};
  if (!colorKey) return;
  const vals = [...new Set(data.map(r => String(r[colorKey] || '')).filter(Boolean))].sort();
  vals.forEach((v, i) => colorMap[v] = PALETTE[i % PALETTE.length]);
}

/* ── Status / auto-save ── */
function setStatus(saved) {
  const s = document.getElementById('status');
  if (saved) { s.textContent = 'Saved'; s.className = 'saved'; dirty = false; }
  else { s.textContent = 'Unsaved changes'; s.className = 'unsaved'; dirty = true; }
}

function autoSave() {
  const ind = document.getElementById('autosave-ind');
  ind.textContent = 'saving...';
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
    localStorage.setItem(HIST_KEY, JSON.stringify(hist.slice(-30)));
    localStorage.setItem(REDO_KEY, JSON.stringify(redoStack.slice(-30)));
    localStorage.setItem(META_KEY, JSON.stringify({ ts: Date.now(), count: data.length, file: fileName }));
    localStorage.setItem(SCHEMA_KEY, JSON.stringify({ latKey, lonKey, labelKey, subtitleKey, colorKey }));
  } catch(e) {
    if (e.name === 'QuotaExceededError') {
      localStorage.setItem(HIST_KEY, JSON.stringify(hist.slice(-10)));
      localStorage.setItem(REDO_KEY, '[]');
    }
  }
  setTimeout(() => {
    const meta = JSON.parse(localStorage.getItem(META_KEY) || '{}');
    ind.textContent = meta.ts ? `cached ${timeAgo(meta.ts)}` : '';
  }, 400);
}

function scheduleAutoSave() { clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(autoSave, 800); }

function pushHistory() {
  hist.push(JSON.stringify(data));
  if (hist.length > 50) hist.shift();
  redoStack = [];
  setStatus(false);
  scheduleAutoSave();
}

function undoLast() {
  if (!hist.length) { toast('Nothing to undo'); return; }
  redoStack.push(JSON.stringify(data));
  data = JSON.parse(hist.pop());
  renderAll();
  toast('Undone');
  if (!hist.length) setStatus(true);
  scheduleAutoSave();
}

function redoLast() {
  if (!redoStack.length) { toast('Nothing to redo'); return; }
  hist.push(JSON.stringify(data));
  data = JSON.parse(redoStack.pop());
  renderAll();
  toast('Redone');
  setStatus(false);
  scheduleAutoSave();
}

/* ── Filtering & search ── */
function applySearch() {
  const q = document.getElementById('search').value.toLowerCase().trim();
  filtered = data.filter(r => {
    if (q) {
      const hay = columns.map(c => String(r[c.key] || '')).join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    for (const k of Object.keys(activeFilters)) {
      const set = activeFilters[k];
      if (set.size === 0) continue;
      const val = String(r[k] || '');
      const parts = val.includes(';') ? val.split(';').map(s => s.trim()) : [val];
      if (!parts.some(p => set.has(p))) return false;
    }
    return true;
  });
  if (sortCol) {
    filtered.sort((a, b) => {
      let va = a[sortCol], vb = b[sortCol];
      if (typeof va === 'number' && typeof vb === 'number') return sortDir === 'asc' ? va - vb : vb - va;
      va = String(va || '').toLowerCase(); vb = String(vb || '').toLowerCase();
      return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
    });
  }
}

/* ── Table rendering ── */
function buildHeader() {
  const row = document.getElementById('header-row');
  row.innerHTML = '<th style="width:50px">#</th>';
  columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col.label;
    th.style.minWidth = col.w + 'px';
    th.onclick = () => { if (sortCol === col.key) sortDir = sortDir === 'asc' ? 'desc' : 'asc'; else { sortCol = col.key; sortDir = 'asc'; } renderAll(); };
    if (sortCol === col.key) th.className = sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc';
    row.appendChild(th);
  });
}

function renderTable() {
  applySearch();
  buildHeader();
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  filtered.forEach(r => {
    const idx = data.indexOf(r);
    const tr = document.createElement('tr');
    tr.dataset.idx = idx;

    const actTd = document.createElement('td');
    actTd.innerHTML = `<div class="row-actions"><button class="row-btn" onclick="openEditModal(${idx})" title="Edit">&#9998;</button><button class="row-btn del" onclick="confirmDelete(${idx})" title="Delete">&times;</button></div>`;
    tr.appendChild(actTd);

    columns.forEach(col => {
      const td = document.createElement('td');
      const val = r[col.key];
      const str = val == null ? '' : String(val);

      if (isUrl(str)) {
        td.innerHTML = `<a href="${esc(str)}" target="_blank">${esc(str)}</a>`;
      } else if (col.key === colorKey && str && colorMap[str]) {
        td.innerHTML = `<span style="display:inline-block;padding:1px 8px;border-radius:8px;font-size:10px;color:#fff;background:${colorMap[str]}">${esc(str)}</span>`;
      } else {
        td.textContent = str;
        td.contentEditable = 'true';
        td.dataset.idx = idx;
        td.dataset.key = col.key;
        td.addEventListener('blur', onCellBlur);
        td.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); td.blur(); } });
      }
      td.style.minWidth = col.w + 'px';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  document.getElementById('counter').textContent = `${filtered.length} / ${data.length}`;
}

function onCellBlur(e) {
  const td = e.target;
  const idx = parseInt(td.dataset.idx);
  const key = td.dataset.key;
  let newVal = td.textContent.trim();
  const old = data[idx][key];
  if (typeof old === 'number' && !isNaN(Number(newVal))) newVal = Number(newVal);
  if (data[idx][key] !== newVal) {
    pushHistory();
    data[idx][key] = newVal;
  }
}

/* ── Map rendering ── */
function initMap() {
  if (map) return;
  const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 19 });
  const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 19 });
  const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 19 });
  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri', maxZoom: 18 });
  const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenTopoMap', subdomains: 'abc', maxZoom: 17 });

  map = L.map('map', { zoomControl: true, layers: [dark] }).setView([30, 0], 2);
  L.control.layers({ Dark: dark, Light: light, Street: street, Satellite: satellite, Topo: topo }, null, { position: 'topright', collapsed: true }).addTo(map);

  markerCluster = L.markerClusterGroup({ maxClusterRadius: 35, showCoverageOnHover: false, zoomToBoundsOnClick: true, disableClusteringAtZoom: 13 });
  map.addLayer(markerCluster);
}

function createIcon(color) {
  return L.divIcon({
    className: '',
    html: `<div style="width:12px;height:12px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4)"></div>`,
    iconSize: [12,12], iconAnchor: [6,6]
  });
}

function renderMap() {
  if (!map || !hasGeo()) return;
  markerCluster.clearLayers();
  markers = {};

  const items = filtered.filter(r => r[latKey] != null && r[lonKey] != null && !isNaN(r[latKey]) && !isNaN(r[lonKey]));
  items.forEach(r => {
    const idx = data.indexOf(r);
    const color = (colorKey && colorMap[r[colorKey]]) || '#5568f2';
    const name = r[labelKey] || `Row ${idx}`;
    const sub = subtitleKey ? (r[subtitleKey] || '') : '';
    const m = L.marker([r[latKey], r[lonKey]], { icon: createIcon(color) });
    m.bindPopup(`<b>${esc(name)}</b>${sub ? '<br><span style="color:#8888aa">' + esc(sub) + '</span>' : ''}<br><span class="popup-link" data-idx="${idx}">Details &rarr;</span>`);
    m.on('popupopen', function() {
      const link = document.querySelector(`.popup-link[data-idx="${idx}"]`);
      if (link) link.addEventListener('click', function(e) {
        e.stopPropagation();
        map.closePopup();
        openDetailModal(idx);
      });
    });
    markers[idx] = m;
    markerCluster.addLayer(m);
  });

  if (items.length > 0) {
    const bounds = L.latLngBounds(items.map(r => [r[latKey], r[lonKey]]));
    map.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });
  }

  const info = document.getElementById('map-info');
  info.style.display = 'block';
  document.getElementById('map-title').textContent = `${items.length} items with geo data`;
  document.getElementById('map-sub').textContent = `of ${data.length} total`;
}

/* ── Sidebar filters (map panel) ── */
function buildFilters() {
  const container = document.getElementById('sidebar-filters');
  if (!filterableKeys.length || !mapVisible) { container.style.display = 'none'; return; }
  container.style.display = 'block';
  container.innerHTML = '';

  filterableKeys.forEach(k => {
    const vals = new Set();
    data.forEach(r => {
      const v = String(r[k] || '');
      if (v.includes(';')) v.split(';').forEach(s => { const t = s.trim(); if (t) vals.add(t); });
      else if (v) vals.add(v);
    });
    if (vals.size < 2 || vals.size > 40) return;

    if (!activeFilters[k]) activeFilters[k] = new Set();

    const h = document.createElement('h4');
    h.textContent = k.replace(/([A-Z])/g, ' $1').replace(/[_-]/g, ' ').trim();
    h.onclick = () => { const wrap = h.nextElementSibling; wrap.style.display = wrap.style.display === 'none' ? 'flex' : 'none'; };
    container.appendChild(h);

    const wrap = document.createElement('div');
    wrap.style.cssText = 'display:flex;flex-wrap:wrap;gap:2px;margin-bottom:6px';
    [...vals].sort().forEach(v => {
      const tag = document.createElement('span');
      tag.className = 'ftag' + (activeFilters[k].has(v) ? ' on' : '');
      tag.textContent = v;
      if (k === colorKey && colorMap[v]) tag.style.borderColor = colorMap[v];
      tag.onclick = () => {
        if (activeFilters[k].has(v)) { activeFilters[k].delete(v); tag.classList.remove('on'); }
        else { activeFilters[k].add(v); tag.classList.add('on'); if (k === colorKey && colorMap[v]) tag.style.background = colorMap[v]; }
        renderAll();
      };
      wrap.appendChild(tag);
    });
    container.appendChild(wrap);
  });

  const btn = document.createElement('button');
  btn.id = 'filter-reset';
  btn.textContent = 'Reset all filters';
  btn.onclick = () => { Object.keys(activeFilters).forEach(k => activeFilters[k].clear()); buildFilters(); renderAll(); };
  container.appendChild(btn);
}

/* ── Map toggle ── */
function toggleMap() {
  const panel = document.getElementById('map-panel');
  const handle = document.getElementById('resize-handle');
  const btn = document.getElementById('btn-map-toggle');
  mapVisible = !mapVisible;

  if (mapVisible && hasGeo()) {
    panel.classList.remove('hidden');
    handle.style.display = 'block';
    btn.classList.add('btn-active');
    if (!map) initMap();
    setTimeout(() => { map.invalidateSize(); renderMap(); buildFilters(); }, 100);
  } else {
    panel.classList.add('hidden');
    handle.style.display = 'none';
    btn.classList.remove('btn-active');
    document.getElementById('sidebar-filters').style.display = 'none';
  }
}

/* ── Combined render ── */
function renderAll() {
  renderTable();
  if (mapVisible && map) renderMap();
}

/* ── Edit modal ── */
function openAddModal() {
  editIdx = -1;
  document.getElementById('edit-title').textContent = 'Add Row';
  document.getElementById('edit-save-btn').textContent = 'Add';
  const empty = {};
  columns.forEach(c => empty[c.key] = '');
  if (latKey) empty[latKey] = '';
  if (lonKey) empty[lonKey] = '';
  buildForm(empty);
  document.getElementById('edit-overlay').classList.add('show');
}

function openEditModal(idx) {
  editIdx = idx;
  const name = data[idx][labelKey] || `Row ${idx}`;
  document.getElementById('edit-title').textContent = 'Edit: ' + name;
  document.getElementById('edit-save-btn').textContent = 'Save';
  buildForm(data[idx]);
  document.getElementById('edit-overlay').classList.add('show');
}

function buildForm(obj) {
  const body = document.getElementById('edit-modal-body');
  let html = '';
  const allKeys = [...columns.map(c => c.key)];
  if (latKey && !allKeys.includes(latKey)) allKeys.push(latKey);
  if (lonKey && !allKeys.includes(lonKey)) allKeys.push(lonKey);

  allKeys.forEach(k => {
    const val = obj[k] == null ? '' : String(obj[k]);
    const col = columns.find(c => c.key === k);
    const isLong = col ? col.long : false;
    const label = k.replace(/([A-Z])/g, ' $1').replace(/[_-]/g, ' ').trim();
    const isNum = (k === latKey || k === lonKey || typeof obj[k] === 'number');

    if (isLong) {
      html += `<div class="fg"><label>${esc(label)}</label><textarea id="f-${esc(k)}">${esc(val)}</textarea></div>`;
    } else {
      html += `<div class="fg"><label>${esc(label)}</label><input id="f-${esc(k)}" ${isNum ? 'type="number" step="any"' : ''} value="${esc(val)}"></div>`;
    }
  });
  body.innerHTML = html;
}

function saveEdit() {
  const obj = {};
  const allKeys = [...columns.map(c => c.key)];
  if (latKey && !allKeys.includes(latKey)) allKeys.push(latKey);
  if (lonKey && !allKeys.includes(lonKey)) allKeys.push(lonKey);

  allKeys.forEach(k => {
    const el = document.getElementById('f-' + k);
    if (!el) return;
    let v = el.value.trim();
    if (editIdx >= 0 && typeof data[editIdx][k] === 'number' && !isNaN(Number(v))) v = Number(v);
    else if ((k === latKey || k === lonKey) && v) v = parseFloat(v) || null;
    obj[k] = v;
  });

  pushHistory();
  if (editIdx === -1) {
    data.push(obj);
    toast('Row added');
  } else {
    Object.assign(data[editIdx], obj);
    toast('Row updated');
  }
  closeEditModal();
  renderAll();
  if (mapVisible && hasGeo()) buildFilters();
}

function closeEditModal() { document.getElementById('edit-overlay').classList.remove('show'); }

/* ── Detail modal (from map) ── */
function openDetailModal(idx) {
  const r = data[idx]; if (!r) return;
  const name = r[labelKey] || `Row ${idx}`;
  document.getElementById('detail-title').textContent = name;
  let html = '';
  columns.forEach(col => {
    const val = r[col.key];
    const str = val == null ? '' : String(val);
    if (!str) return;
    const label = col.label;
    if (isUrl(str)) {
      html += `<div class="drow"><div class="dlbl">${esc(label)}</div><div class="dval"><a href="${esc(str)}" target="_blank">${esc(str)}</a></div></div>`;
    } else {
      html += `<div class="drow"><div class="dlbl">${esc(label)}</div><div class="dval">${esc(str)}</div></div>`;
    }
  });
  document.getElementById('detail-body').innerHTML = html;
  document.getElementById('detail-overlay').classList.add('show');
}
function closeDetailModal() { document.getElementById('detail-overlay').classList.remove('show'); }
window.openDetailModal = openDetailModal;

/* ── Delete ── */
function confirmDelete(idx) {
  pendingConfirm = idx;
  const name = data[idx][labelKey] || `Row ${idx}`;
  document.getElementById('confirm-msg').textContent = `Delete "${name}"?`;
  document.getElementById('confirm-overlay').classList.add('show');
}

function confirmAction() {
  if (pendingConfirm !== null) {
    pushHistory();
    data.splice(pendingConfirm, 1);
    renderAll();
    if (mapVisible && hasGeo()) buildFilters();
    toast('Row deleted');
  }
  closeConfirm();
}
function closeConfirm() { pendingConfirm = null; document.getElementById('confirm-overlay').classList.remove('show'); }

/* ── Save ── */
async function saveToFile() {
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(a.href);
  setStatus(true);
  toast(`Downloaded ${fileName}`);
}

/* ── File loading ── */
function loadData(arr, name) {
  if (!Array.isArray(arr) || !arr.length) { toast('JSON must be a non-empty array', 3000); return; }
  data = arr;
  fileName = name || 'data.json';
  hist = [];
  redoStack = [];
  activeFilters = {};
  detectSchema(data);
  buildColorMap();

  document.getElementById('landing').classList.add('hidden');
  document.getElementById('topbar').style.display = 'flex';
  document.getElementById('main').style.display = 'flex';
  document.getElementById('app-title').textContent = fileName;

  if (hasGeo()) {
    document.getElementById('btn-map-toggle').style.display = '';
    if (!mapVisible) toggleMap();
    else { initMap(); setTimeout(() => { map.invalidateSize(); renderMap(); buildFilters(); }, 100); }
  } else {
    document.getElementById('btn-map-toggle').style.display = 'none';
    if (mapVisible) toggleMap();
  }

  renderAll();
  setStatus(true);
  autoSave();
}

function handleLandingUpload(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try { loadData(JSON.parse(e.target.result), file.name); }
    catch(err) { toast('Invalid JSON: ' + err.message, 4000); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function handleFileUpload(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      if (!Array.isArray(parsed)) { toast('JSON must be an array', 3000); return; }
      loadData(parsed, file.name);
      toast(`Loaded ${data.length} rows from ${file.name}`);
    } catch(err) { toast('Invalid JSON: ' + err.message, 4000); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function loadDefault() {
  fetch('xr-companies.json')
    .then(r => r.json())
    .then(d => loadData(d, 'xr-companies.json'))
    .catch(err => toast('Error loading: ' + err.message, 5000));
}

/* ── Drag & drop ── */
const dz = document.getElementById('drop-zone');
['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('dragover'); }));
['dragleave','drop'].forEach(ev => dz.addEventListener(ev, () => dz.classList.remove('dragover')));
dz.addEventListener('drop', e => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (!file || !file.name.endsWith('.json')) { toast('Please drop a .json file'); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    try { loadData(JSON.parse(ev.target.result), file.name); }
    catch(err) { toast('Invalid JSON: ' + err.message, 4000); }
  };
  reader.readAsText(file);
});

/* ── Resize handle ── */
const resizeHandle = document.getElementById('resize-handle');
let resizing = false;
resizeHandle.addEventListener('mousedown', e => {
  resizing = true; resizeHandle.classList.add('active');
  e.preventDefault();
});
document.addEventListener('mousemove', e => {
  if (!resizing) return;
  const pct = (e.clientX / window.innerWidth) * 100;
  document.getElementById('map-panel').style.width = Math.max(20, Math.min(70, pct)) + '%';
  if (map) map.invalidateSize();
});
document.addEventListener('mouseup', () => { resizing = false; resizeHandle.classList.remove('active'); });

/* ── Keyboard shortcuts ── */
document.getElementById('search').addEventListener('input', renderAll);
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeEditModal(); closeDetailModal(); closeConfirm(); }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'z') { e.preventDefault(); redoLast(); }
  else if ((e.metaKey || e.ctrlKey) && e.key === 'z') { e.preventDefault(); undoLast(); }
  if ((e.metaKey || e.ctrlKey) && e.key === 'y') { e.preventDefault(); redoLast(); }
  if ((e.metaKey || e.ctrlKey) && e.key === 's') { e.preventDefault(); saveToFile(); }
});

window.addEventListener('beforeunload', e => {
  if (dirty) { autoSave(); e.preventDefault(); e.returnValue = ''; }
});

/* ── Cache indicator refresh ── */
setInterval(() => {
  const ind = document.getElementById('autosave-ind');
  const meta = JSON.parse(localStorage.getItem(META_KEY) || '{}');
  if (meta.ts) ind.textContent = `cached ${timeAgo(meta.ts)}`;
}, 15000);

/* ── Init: check cache, then try default file ── */
(function startup() {
  const cached = localStorage.getItem(CACHE_KEY);
  const meta = JSON.parse(localStorage.getItem(META_KEY) || '{}');
  if (cached && meta.ts) {
    try {
      const parsed = JSON.parse(cached);
      if (Array.isArray(parsed) && parsed.length > 0) {
        const savedHist = localStorage.getItem(HIST_KEY);
        const savedRedo = localStorage.getItem(REDO_KEY);
        hist = savedHist ? JSON.parse(savedHist) : [];
        redoStack = savedRedo ? JSON.parse(savedRedo) : [];
        fileName = meta.file || 'data.json';
        data = parsed;
        detectSchema(data);
        buildColorMap();

        document.getElementById('landing').classList.add('hidden');
        document.getElementById('topbar').style.display = 'flex';
        document.getElementById('main').style.display = 'flex';
        document.getElementById('app-title').textContent = fileName;

        if (hasGeo()) {
          document.getElementById('btn-map-toggle').style.display = '';
          toggleMap();
        } else {
          document.getElementById('btn-map-toggle').style.display = 'none';
        }

        renderAll();
        setStatus(false);
        toast(`Restored ${data.length} rows from cache (${timeAgo(meta.ts)})`, 3000);
        document.getElementById('autosave-ind').textContent = `cached ${timeAgo(meta.ts)}`;
        return;
      }
    } catch(e) {}
  }

  fetch('xr-companies.json').then(r => { if (r.ok) return r.json(); throw new Error(); })
    .then(d => {
      if (Array.isArray(d) && d.length) {
        document.getElementById('load-default-btn').style.display = 'inline-block';
      }
    })
    .catch(() => {});
})();
</script>
</body>
</html>
